<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://systemjs.sh" />
    <link rel="icon" type="image/svg+xml" href="./vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Systemjs.sh example: Vite + Vue</title>
    <!--
      The only global variable defined will be `System`
    -->
    <script src="https://systemjs.sh/systemjs/dist/s.min.js?raw"></script>
    <!--
      Once `System` is loaded we can add an importmap with maps
      scoped/limited to our third-party domain (for example: esroyo.github.io).
      We are not interferring with other consumers of `System`, if they exist.
    -->
    <script id="importmap">
    System.addImportMap({
      // The first-party code will use vue@latest
      "imports": {
        "vue": "https://systemjs.sh/vue",
      },
      "scopes": {
        // The third-party code will use vue@3.3
        "https://esroyo.github.io/systemjs-cdn-examples/": {
          "vue": "https://systemjs.sh/vue@3.3",
        }
      },
    });
    </script>
    <!-- This is the third-party code that uses vue@3.3 -->
    
    <script crossorigin src="https://esroyo.github.io/systemjs-cdn-examples/dist/assets/index.js"></script>
  </head>
  <body style="display: flex; flex-direction: column;">
    <div id="info" style="max-width: 95vw;"></div>
    <div id="app" style="border: .2em dashed red"></div>
    <!-- This is the first-party code that uses vue@latest -->
    <script>
window.addEventListener('DOMContentLoaded', () => {
  System.import('vue').then((mod) => {
    console.log(`${window.location.hostname} is using vue@${mod.version}`);
    document.title = `${document.title} (${mod.version})`;
    info.innerHTML =`
      <p>First party domain (<code>${location.hostname}</code>) is using <strong>vue@latest (${mod.version})</strong></p>
      <textarea style="max-width: 95vw; width: 500px; height: 200px;">${importmap.textContent}</textarea>      
      <p>The following <span style="color: red">box</span> is mounted by a third-party (<code>esroyo.github.io</code>):</p>`;
  });
});
    </script>
    <script>
function tabular(list) {
  const cols = [...new Set(list.map((obj) => Object.keys(obj)).flat())];
  return [
    cols,
    ...list.map((obj) => cols.map((col) => obj[col])),
  ];
}

function table(list) {
  return `
<style>
tr:nth-child(even) {background-color: #f2f2f2;}
th, td { padding: 6px; }
th, td { max-width: 14em; min-width: 5em; }
table { border-collapse: collapse }
table, th, td { border: 1px solid; }
</style>
<code>
<table>
<thead><tr>${list[0].map((head) => `<th>${head}</th>`).join('')}</tr></thead>
<tbody>${list.slice(1).map(row => `<tr>${row.map((data) => `<td>${data ?? ''}</td>`).join('')}</tr>`).join('\n')}</tbody>
</table>
</code>`;
}

function updateNetDebug() {
const list = [
...performance.getEntriesByType('resource')
	.filter(({ name }) => name.startsWith('https://systemjs.sh/'))
	.map(({ name, duration, serverTiming, transferSize }) => {
		const { total: serverDuration, ...otherServerTiming } = Object.fromEntries(serverTiming.map(st => [st.description || st.name, st.duration ]));
return { name, duration, serverDuration, diff: duration - serverDuration, transferSize, ...otherServerTiming };
  }),
];
const debugDiv = document.querySelector('#net-debug') || document.createElement('div');
debugDiv.id = 'net-debug';
debugDiv.innerHTML = table(tabular(list));
if (!debugDiv.parentNode) {
  document.body.prepend(debugDiv);
}
}

const href = new URL(location.href);
if (href.searchParams.has('net-debug')) {
const observer = new PerformanceObserver(updateNetDebug);
observer.observe({ type: "resource", buffered: true });
}
    </script>
  </body>
</html>
